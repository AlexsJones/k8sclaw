name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  BINARY: kubeclaw

jobs:
  # ── Build CLI binaries ──────────────────────────────────────────────────────
  build:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "0"
        run: |
          TAG="${GITHUB_REF_NAME}"
          PLATFORM="${{ matrix.goos }}-${{ matrix.goarch }}"
          ASSET="${BINARY}-${PLATFORM}"

          go build \
            -ldflags "-s -w -X main.version=${TAG}" \
            -o kubeclaw \
            ./cmd/kubeclaw/

          tar czf "${ASSET}.tar.gz" kubeclaw

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kubeclaw-${{ matrix.goos }}-${{ matrix.goarch }}
          path: kubeclaw-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz

  # ── Package manifests bundle ────────────────────────────────────────────────
  manifests:
    name: Package manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bundle manifests
        run: |
          tar czf kubeclaw-manifests.tar.gz \
            config/crd/bases/ \
            config/nats/ \
            config/cert/ \
            config/rbac/ \
            config/manager/ \
            config/webhook/ \
            config/network/ \
            config/skills/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kubeclaw-manifests
          path: kubeclaw-manifests.tar.gz

  # ── Create GitHub Release ───────────────────────────────────────────────────
  release:
    name: Create GitHub Release
    needs: [build, manifests]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/*.tar.gz

  # ── Update Homebrew tap ─────────────────────────────────────────────────────
  update-homebrew:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout tap
        uses: actions/checkout@v4
        with:
          repository: AlexsJones/homebrew-kubeclaw
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Download release assets and update formula
        env:
          TAG: ${{ github.ref_name }}
        run: |
          VERSION="${TAG#v}"

          # Download the four tarballs and compute SHA256
          declare -A SHAS
          for platform in darwin-amd64 darwin-arm64 linux-amd64 linux-arm64; do
            URL="https://github.com/AlexsJones/kubeclaw/releases/download/${TAG}/kubeclaw-${platform}.tar.gz"
            echo "Downloading ${URL}..."
            SHA=$(curl -fsSL "$URL" | shasum -a 256 | awk '{print $1}')
            SHAS[$platform]="$SHA"
            echo "${platform}: ${SHA}"
          done

          # Generate the formula
          cat > homebrew-tap/Formula/kubeclaw.rb << RUBY
          class Kubeclaw < Formula
            desc "Kubernetes-native AI agent orchestration platform CLI"
            homepage "https://github.com/AlexsJones/kubeclaw"
            version "${VERSION}"
            license "Apache-2.0"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/AlexsJones/kubeclaw/releases/download/v#{version}/kubeclaw-darwin-arm64.tar.gz"
                sha256 "${SHAS[darwin-arm64]}"
              else
                url "https://github.com/AlexsJones/kubeclaw/releases/download/v#{version}/kubeclaw-darwin-amd64.tar.gz"
                sha256 "${SHAS[darwin-amd64]}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/AlexsJones/kubeclaw/releases/download/v#{version}/kubeclaw-linux-arm64.tar.gz"
                sha256 "${SHAS[linux-arm64]}"
              else
                url "https://github.com/AlexsJones/kubeclaw/releases/download/v#{version}/kubeclaw-linux-amd64.tar.gz"
                sha256 "${SHAS[linux-amd64]}"
              end
            end

            def install
              bin.install "kubeclaw"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/kubeclaw version")
            end
          end
          RUBY

          # Fix heredoc indentation
          sed -i 's/^          //' homebrew-tap/Formula/kubeclaw.rb

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/kubeclaw.rb
          git commit -m "Update kubeclaw to ${GITHUB_REF_NAME}"
          git push
