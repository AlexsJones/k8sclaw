name: Release CLI

on:
  push:
    tags: ["v*"]

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io/alexsjones/kubeclaw

jobs:
  release-cli:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build CLI
        env:
          CGO_ENABLED: "0"
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          VERSION="${GITHUB_REF_NAME}"
          go build -ldflags="-s -w -X main.version=${VERSION}" \
            -o kubeclaw ./cmd/kubeclaw

      - name: Package
        run: |
          PLATFORM="${{ matrix.goos }}-${{ matrix.goarch }}"
          tar -czf "kubeclaw-${PLATFORM}.tar.gz" kubeclaw
          sha256sum "kubeclaw-${PLATFORM}.tar.gz" > "kubeclaw-${PLATFORM}.tar.gz.sha256"

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            kubeclaw-*.tar.gz
            kubeclaw-*.sha256

  release-manifests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Package install manifests
        run: |
          tar -czf kubeclaw-manifests.tar.gz \
            config/crd/bases/ \
            config/manager/ \
            config/rbac/ \
            config/webhook/ \
            config/network/ \
            config/nats/ \
            config/cert/ \
            config/skills/ \
            config/policies/

      - name: Upload manifests
        uses: softprops/action-gh-release@v2
        with:
          files: kubeclaw-manifests.tar.gz

  release-images:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image:
          - agent-runner
          - controller
          - apiserver
          - ipc-bridge
          - webhook
          - channel-telegram
          - channel-whatsapp
          - channel-discord
          - channel-slack
          - skill-k8s-ops
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ matrix.image }}
          tags: |
            type=semver,pattern=v{{version}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: images/${{ matrix.image }}/Dockerfile
          push: true
          build-args: |
            IMAGE_TAG=${{ github.ref_name }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ── Update Homebrew tap ─────────────────────────────────────────────────────
  update-homebrew:
    name: Update Homebrew tap
    needs: release-cli
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap
        uses: actions/checkout@v4
        with:
          repository: AlexsJones/homebrew-kubeclaw
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Download release assets and update formula
        env:
          TAG: ${{ github.ref_name }}
        run: |
          VERSION="${TAG#v}"

          declare -A SHAS
          for platform in darwin-amd64 darwin-arm64 linux-amd64 linux-arm64; do
            URL="https://github.com/AlexsJones/kubeclaw/releases/download/${TAG}/kubeclaw-${platform}.tar.gz"
            echo "Hashing ${URL}..."
            SHA=$(curl -fsSL "${URL}" | shasum -a 256 | awk '{print $1}')
            SHAS[$platform]="${SHA}"
            echo "  ${platform}: ${SHA}"
          done

          mkdir -p homebrew-tap/Formula

          cat > homebrew-tap/Formula/Kubeclaw.rb << RUBY
          class Kubeclaw < Formula
            desc "Kubernetes-native AI agent orchestration platform CLI"
            homepage "https://github.com/AlexsJones/kubeclaw"
            version "${VERSION}"
            license "Apache-2.0"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/AlexsJones/kubeclaw/releases/download/v#{version}/kubeclaw-darwin-arm64.tar.gz"
                sha256 "${SHAS[darwin-arm64]}"
              else
                url "https://github.com/AlexsJones/kubeclaw/releases/download/v#{version}/kubeclaw-darwin-amd64.tar.gz"
                sha256 "${SHAS[darwin-amd64]}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/AlexsJones/kubeclaw/releases/download/v#{version}/kubeclaw-linux-arm64.tar.gz"
                sha256 "${SHAS[linux-arm64]}"
              else
                url "https://github.com/AlexsJones/kubeclaw/releases/download/v#{version}/kubeclaw-linux-amd64.tar.gz"
                sha256 "${SHAS[linux-amd64]}"
              end
            end

            def install
              bin.install "kubeclaw"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/kubeclaw version")
            end
          end
          RUBY

          # Fix heredoc indentation
          sed -i 's/^          //' homebrew-tap/Formula/Kubeclaw.rb

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/Kubeclaw.rb
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "Update kubeclaw to ${GITHUB_REF_NAME}"
          git push origin HEAD:main
